<div class="container mt-3">
    <!-- Header + Filter c·ªë ƒë·ªãnh -->
    <div class="position-sticky" style="top: 0; z-index: 1020; background-color: white;">
        <h1 class="p-3 mb-0 border-bottom">Danh s√°ch M√≥n ƒÉn & Th·ª©c u·ªëng</h1>

        <!-- Filter / Ph√¢n lo·∫°i -->
        <div class="d-flex flex-wrap gap-2 p-2 border-bottom align-items-center">
            <!-- Xem t·∫•t c·∫£ -->
            <%= link_to "T·∫•t c·∫£", food_drinks_path, class: "btn btn-sm btn-outline-dark" %>

            <!-- Filter theo category -->
            <% Category.all.each do |cat| %>
            <%= link_to cat.name, food_drinks_path(category_id: cat.id), class: "btn btn-sm btn-outline-primary" %>
            <% end %>

            <!-- üîç T√¨m ki·∫øm + L·ªçc gi√° + rating + sort -->
            <div class="ms-auto" data-controller="search">
                <%= form_with url: food_drinks_path,
              method: :get,
              data: { search_target: "form", turbo_frame: "food_drinks_list" },
              class: "d-flex gap-2 align-items-center",
              local: true do |f| %>

                <%= f.text_field :query,
            value: params[:query],
            placeholder: "T√¨m m√≥n ƒÉn / th·ª©c u·ªëng...",
            class: "form-control form-control-sm",
            style: "min-width: 200px;",
            data: { action: "input->search#update" } %>

                <%= f.number_field :min_price,
            value: params[:min_price],
            placeholder: "Gi√° min",
            class: "form-control form-control-sm",
            data: { action: "input->search#update" } %>

                <%= f.number_field :max_price,
            value: params[:max_price],
            placeholder: "Gi√° max",
            class: "form-control form-control-sm",
            data: { action: "input->search#update" } %>

                <%= f.number_field :min_rating,
            value: params[:min_rating],
            placeholder: "ƒê√°nh gi√° min",
            step: 0.1,
            class: "form-control form-control-sm",
            data: { action: "input->search#update" } %>

                <%= f.select :sort_by,
            options_for_select([["M·∫∑c ƒë·ªãnh (A-Z)", ""], ["Gi√° tƒÉng d·∫ßn", "price_asc"], ["Gi√° gi·∫£m d·∫ßn", "price_desc"]], params[:sort_by]),
            class: "form-select form-select-sm" %>

                <%= f.submit "L·ªçc", class: "btn btn-sm btn-primary" %>
                <% end %>
            </div>
        </div>
    </div>

    <!-- Danh s√°ch m√≥n ƒÉn -->
    <%= turbo_frame_tag "food_drinks_list" do %>
    <div class="row mt-3">
        <% @food_drinks.each do |fd| %>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100">
                <!-- ·∫¢nh -->
                <% if fd.image.attached? %>
                <%= image_tag fd.image, class: "card-img-top", style: "height: 200px; object-fit: cover;" %>
                <% else %>
                <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 200px;">
                    Kh√¥ng c√≥ ·∫£nh
                </div>
                <% end %>

                <div class="card-body d-flex flex-column">
                    <!-- T√™n m√≥n -->
                    <h5 class="card-title">
                        <%= link_to fd.name, food_drink_path(fd), data: { turbo: false } %>
                    </h5>

                    <!-- Rating -->
                    <% avg_score = fd.ratings.average(:score)&.round(1) || 0 %>
                    <% total_ratings = fd.ratings.count %>
                    <% full_stars = avg_score.floor %>
                    <% half_star = ((avg_score - full_stars) >= 0.5) %>
                    <% empty_stars = 5 - full_stars - (half_star ? 1 : 0) %>

                    <div class="d-flex align-items-center mb-2">
                        <% full_stars.times do %>
                        <i class="bi bi-star-fill text-warning"></i>
                        <% end %>
                        <% if half_star %>
                        <i class="bi bi-star-half text-warning"></i>
                        <% end %>
                        <% empty_stars.times do %>
                        <i class="bi bi-star text-warning"></i>
                        <% end %>
                        <span class="ms-2 text-muted" style="font-size: 0.9rem;">
                            <%= avg_score %>/5 - (<%= total_ratings %> ƒë√°nh gi√°)
                        </span>
                    </div>

                    <!-- Gi√° -->
                    <p class="card-text"><strong>Gi√°:</strong> <%= number_to_currency(fd.price, unit: "‚Ç´") %></p>

                    <!-- Danh m·ª•c -->
                    <p class="card-text"><strong>Danh m·ª•c:</strong> <%= fd.category&.name || "Kh√¥ng c√≥" %></p>

                    <!-- S·ªë l∆∞·ª£ng c√≤n -->
                    <p class="card-text">
                        <strong>S·ªë l∆∞·ª£ng c√≤n:</strong>
                        <%= turbo_frame_tag "food_drink_#{fd.id}_stock" do %>
                        <%= fd.stock > 0 ? fd.stock : "H·∫øt h√†ng" %>
                        <% end %>
                    </p>

                    <!-- N√∫t h√†nh ƒë·ªông -->
                    <div class="mt-auto d-flex gap-1">
                        <%= link_to "Xem chi ti·∫øt", food_drink_path(fd), class: "btn btn-sm btn-outline-primary", data: { turbo: false } %>

                        <%= turbo_frame_tag "food_drink_#{fd.id}_button" do %>
                        <% if fd.stock > 0 %>
                        <%= button_to "Th√™m v√†o gi·ªè",
                      cart_items_path,
                      method: :post,
                      params: { food_drink_id: fd.id },
                      form: { data: { turbo_stream: true, turbo_frame: "_top" } },
                      class: "btn btn-sm btn-outline-success" %>
                        <% else %>
                        <button class="btn btn-sm btn-outline-secondary" disabled>H·∫øt h√†ng</button>
                        <% end %>
                        <% end %>
                    </div>
                </div>
            </div>
        </div>
        <% end %>
    </div>

    <% if @food_drinks.empty? %>
    <p class="text-center text-muted mt-4">Kh√¥ng t√¨m th·∫•y m√≥n n√†o ph√π h·ª£p.</p>
    <% end %>
    <% end %>
    <!-- ‚úÖ k·∫øt th√∫c turbo_frame_tag -->
</div>