<div class="container mt-4">

    <!-- Flash messages -->
    <%= turbo_frame_tag "flash_messages" do %>
    <%= render "shared/flash" %>
    <% end %>

    <div class="row">
        <!-- Hình ảnh và thông tin cơ bản -->
        <div class="col-lg-5 mb-3">
            <div class="card shadow-sm">
                <% if @food_drink.image.attached? %>
                <%= image_tag @food_drink.image, class: "card-img-top rounded", style: "object-fit: cover; height: 300px;" %>
                <% else %>
                <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 300px;">
                    Không có ảnh
                </div>
                <% end %>

                <div class="card-body">
                    <h3 class="card-title mb-2"><%= @food_drink.name %></h3>
                    <p class="card-text mb-1"><strong>Giá:</strong> <%= number_to_currency(@food_drink.price, unit: "₫") %></p>
                    <p class="card-text mb-1"><strong>Danh mục:</strong> <%= @food_drink.category&.name || "Không có" %></p>
                    <p class="card-text"><strong>Mô tả:</strong> <%= @food_drink.description.presence || "Chưa có mô tả" %></p>
                </div>
            </div>
        </div>

        <!-- Thao tác mua hàng và đánh giá -->
        <div class="col-lg-7">
            <div class="card shadow-sm p-3 mb-3">
                <!-- Nút thao tác -->
                <div class="d-flex gap-2 mb-3 flex-wrap">
                    <% if @food_drink.stock > 0 && user_signed_in? %>
                    <%= button_to "Thêm vào giỏ", cart_items_path,
                method: :post,
                params: { food_drink_id: @food_drink.id },
                form: { data: { turbo: true } },
                class: "btn btn-success btn-sm" %>
                    <% elsif @food_drink.stock > 0 %>
                    <%= link_to "Đăng nhập để mua", new_user_session_path, class: "btn btn-warning btn-sm" %>
                    <% else %>
                    <button class="btn btn-secondary btn-sm" disabled>Hết hàng</button>
                    <% end %>
                    <%= link_to "Quay lại", food_drinks_path, class: "btn btn-outline-secondary btn-sm" %>
                </div>

                <hr>

                <!-- Đánh giá của user -->
                <% if user_signed_in? %>
                <h5>Đánh giá của bạn</h5>
                <% user_rating = @food_drink.ratings.find_by(user: current_user) %>
                <%= turbo_frame_tag "user_rating_form" do %>
                <% if user_rating.nil? %>
                <%= render "ratings/form", rating: @food_drink.ratings.new(user: current_user), food_drink: @food_drink %>
                <% else %>
                <div id="user_rating_form_placeholder">
                    <%= link_to "Cập nhật đánh giá",
                            edit_food_drink_rating_path(@food_drink, user_rating),
                            data: { turbo_frame: "user_rating_form", turbo_prefetch: false },
                            class: "btn btn-primary btn-sm" %>
                </div>
                <% end %>
                <% end %>
                <% else %>
                <p><%= link_to "Đăng nhập", new_user_session_path %> để đánh giá sản phẩm.</p>
                <% end %>

                <hr>

                <!-- Danh sách đánh giá -->
                <h5>Đánh giá sản phẩm</h5>
                <%= turbo_frame_tag "ratings_list" do %>
                <%= render "ratings/list", ratings: @food_drink.ratings.includes(:user) %>
                <% end %>

                <hr>

                <!-- Chia sẻ -->
                <h5 class="mb-2">Chia sẻ sản phẩm</h5>
                <div class="d-flex flex-column flex-md-row gap-2 w-100">
                    <a href="https://www.facebook.com/sharer/sharer.php?u=<%= request.original_url %>" target="_blank" class="btn btn-primary flex-fill">
                        Facebook
                    </a>
                    <a href="https://twitter.com/intent/tweet?url=<%= request.original_url %>" target="_blank" class="btn btn-info text-white flex-fill">
                        Twitter
                    </a>
                </div>


            </div>
        </div>
    </div>
</div>

<!-- JS cho đánh giá sao -->
<script>
    function initStarRating(wrapper) {
        const ratingForm = wrapper?.querySelector('[data-rating-form]');
        if (!ratingForm) return;

        const input = ratingForm.querySelector('[data-rating-input]');
        const stars = ratingForm.querySelectorAll('.star');
        const error = ratingForm.querySelector('[data-rating-error]');

        const updateStars = (val) => {
            stars.forEach(star => {
                star.style.color = parseInt(star.dataset.value) <= val ? 'gold' : 'lightgray';
            });
        };

        stars.forEach(star => {
            star.onclick = () => {
                const val = parseInt(star.dataset.value);
                input.value = val;
                updateStars(val);
                error.classList.add('d-none');
            };
        });

        updateStars(parseInt(input.value) || 0);

        const form = ratingForm.closest('form');
        form.addEventListener('submit', (e) => {
            const val = parseInt(input.value);
            if (!val || val < 1 || val > 5) {
                e.preventDefault();
                error.classList.remove('d-none');
                input.focus();
            }
        });
    }

    document.addEventListener('turbo:load', () => {
        const wrapper = document.querySelector('#user_rating_form');
        if (wrapper) initStarRating(wrapper);
    });

    document.addEventListener('turbo:frame-load', (e) => {
        if (e.target.id === 'user_rating_form') {
            initStarRating(e.target);
            const form = e.target.querySelector('form');
            if (form) form.reset();
            const stars = form?.querySelectorAll('.star') || [];
            stars.forEach(star => star.style.color = 'lightgray');
            const error = form?.querySelector('[data-rating-error]');
            if (error) error.classList.add('d-none');
        }
    });
</script>